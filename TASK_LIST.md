# Voice Changer - タスク一覧

> **本ドキュメントについて**
>
> プロジェクトの全タスクと進捗状況を管理します。
> タスク完了時は必ずステータスを更新してください。
>
> **ステータス凡例**
> - [ ] 未着手
> - [~] 進行中
> - [x] 完了
> - [-] スキップ/不要

---

## 進捗サマリー

| フェーズ | 進捗 | 完了タスク | 総タスク |
|---------|------|-----------|---------|
| Phase 0: 環境構築 | 73% | 11 | 15 |
| Phase 1: MVP (Speaking) | 22% | 10 | 45 |
| Phase 2: Listening + 安定化 | 0% | 0 | 25 |
| Phase 3: 高度な音声変換 | 0% | 0 | 15 |
| **合計** | **21%** | **21** | **100** |

---

## Phase 0: 環境構築・基盤整備

### 0.1 開発環境セットアップ

- [ ] **0.1.1** Xcode 15+ インストール確認
- [ ] **0.1.2** macOS 14+ (Sonoma) 開発機準備
- [ ] **0.1.3** Apple Developer Program 登録確認
- [ ] **0.1.4** コード署名証明書・プロビジョニング設定
- [x] **0.1.5** Git リポジトリ初期化 → https://github.com/h-abe222/voice-changer-macos

### 0.2 GCP 環境構築

- [x] **0.2.1** GCP プロジェクト作成 → `voice-changer-mac` (info@haruniko.co.jp)
  - [x] プロジェクトID決定・作成
  - [x] 請求先アカウント設定
  - [x] IAM権限設定（開発者用）

- [x] **0.2.2** Cloud Build 設定（CI/CD）
  - [x] Cloud Build API 有効化
  - [ ] ビルドトリガー設定（main/develop ブランチ）
  - [ ] macOS ビルド用設定（※外部CIとの連携検討）

- [x] **0.2.3** Cloud Storage 設定（成果物保管）
  - [x] バケット作成（ビルド成果物用） → `voice-changer-mac-builds`
  - [x] バケット作成（クラッシュログ/診断データ用） → `voice-changer-mac-logs`
  - [x] ライフサイクルポリシー設定（90日で削除）

- [ ] **0.2.4** Firestore 設定（ユーザーデータ・プリセット共有 - 将来用）
  - [x] Firestore API 有効化
  - [ ] セキュリティルール設計

- [x] **0.2.5** Cloud Functions 設定（将来のAPI用）
  - [x] Functions API 有効化
  - [x] サービスアカウント作成 → `voice-changer-cicd@voice-changer-mac.iam.gserviceaccount.com`

### 0.3 プロジェクト構造作成

- [x] **0.3.1** Swift Package プロジェクト作成
  - [x] Package.swift 作成
  - [x] ターゲット設定（VoiceChangerApp, AudioEngine, DSP, Tests）
  - [ ] Build Settings 最適化

- [x] **0.3.2** ディレクトリ構造作成
  - [x] App/Sources/ 以下のフォルダ作成
  - [x] VirtualMicDriver/ フォルダ作成
  - [x] Tests/ フォルダ作成

- [x] **0.3.3** 依存関係管理
  - [x] Swift Package Manager 設定
  - [ ] 外部ライブラリ追加（必要に応じて）

---

## Phase 1: MVP - Speaking Mode

### 1.1 仮想マイクドライバ (Virtual Mic)

#### 1.1.1 調査・設計
- [x] **1.1.1.1** BlackHole ソースコード調査
  - [x] Audio Server Driver Plug-in 構造理解
  - [x] デバイス登録フロー確認
  - [x] ストリーム処理フロー確認

- [x] **1.1.1.2** 仮想マイク設計ドキュメント作成 → [VIRTUAL_MIC_DESIGN.md](docs/VIRTUAL_MIC_DESIGN.md)
  - [x] インターフェース設計
  - [x] メモリ共有方式決定
  - [x] エラーハンドリング設計

#### 1.1.2 実装
- [~] **1.1.2.1** VirtualMicDriver プロジェクト作成
  - [x] ソースファイル作成（VirtualMicDriver.c/.h, VirtualMicProperties.c）
  - [x] Info.plist 設定
  - [ ] Entitlements 設定
  - [ ] Xcodeプロジェクト設定

- [x] **1.1.2.2** デバイス登録実装
  - [x] PlugIn エントリポイント実装
  - [x] AudioServerPlugInDriverInterface 実装
  - [x] デバイスUID/名前設定

- [x] **1.1.2.3** ストリーム処理実装
  - [x] 入力ストリーム作成
  - [x] IOProc コールバック実装
  - [x] サンプルレート対応（48kHz）

- [x] **1.1.2.4** 共有メモリ実装
  - [x] Ring Buffer 読み取り
  - [x] App との接続インターフェース（POSIX shm_open）

#### 1.1.3 検証
- [ ] **1.1.3.1** デバイス認識テスト
  - [ ] システム環境設定で表示確認
  - [ ] Audio MIDI設定で表示確認
  - [ ] Chrome（Meet）で選択可能確認

- [ ] **1.1.3.2** 音声出力テスト
  - [ ] テストトーン出力確認
  - [ ] 無音時の安定性確認

### 1.2 音声キャプチャ (Audio Capture)

#### 1.2.1 実装
- [ ] **1.2.1.1** DeviceManager 実装
  - [ ] 入力デバイス列挙機能
  - [ ] 出力デバイス列挙機能
  - [ ] デバイス変更監視機能
  - [ ] デフォルトデバイス取得

- [ ] **1.2.1.2** AudioCapture 実装
  - [ ] AudioUnit 設定
  - [ ] 入力コールバック実装
  - [ ] フォーマット変換（必要時）
  - [ ] Ring Buffer への書き込み

- [ ] **1.2.1.3** 権限管理実装
  - [ ] マイク権限リクエスト
  - [ ] 権限状態監視
  - [ ] 権限拒否時のUI誘導

#### 1.2.2 検証
- [ ] **1.2.2.1** キャプチャテスト
  - [ ] 内蔵マイクからの取得確認
  - [ ] USBマイクからの取得確認
  - [ ] サンプルレート確認（48kHz）

### 1.3 DSP Chain（音声処理）

#### 1.3.1 基盤実装
- [ ] **1.3.1.1** DSPChain フレームワーク
  - [ ] AudioFrame 型定義
  - [ ] DSPNode プロトコル定義
  - [ ] Chain 接続/処理フロー実装

- [ ] **1.3.1.2** Ring Buffer 実装
  - [ ] SPSC Lock-free Ring Buffer
  - [ ] オーバーラン/アンダーラン検出
  - [ ] 統計情報収集

#### 1.3.2 DSP モジュール実装
- [ ] **1.3.2.1** HPF（ハイパスフィルタ）
  - [ ] 80Hz カットオフ実装
  - [ ] Accelerate vDSP 使用

- [ ] **1.3.2.2** Noise Suppressor
  - [ ] WebRTC NS 組み込み or 自作
  - [ ] 強度パラメータ対応

- [ ] **1.3.2.3** AGC（自動ゲイン調整）
  - [ ] ターゲットレベル設定
  - [ ] Attack/Release 時間設定
  - [ ] Accelerate vDSP 使用

- [ ] **1.3.2.4** Pitch Shifter
  - [ ] Phase Vocoder 実装
  - [ ] ±12半音対応
  - [ ] レイテンシ最適化

- [ ] **1.3.2.5** Formant Shifter
  - [ ] LPC 分析実装
  - [ ] フォルマント独立制御
  - [ ] Pitch と連携

- [ ] **1.3.2.6** Equalizer（3バンド）
  - [ ] Low/Mid/High バンド
  - [ ] Biquad Filter 実装

- [ ] **1.3.2.7** Limiter
  - [ ] Soft Knee 実装
  - [ ] Ceiling -1dB 設定

#### 1.3.3 プリセット管理
- [ ] **1.3.3.1** VoicePreset 型定義
  - [ ] JSON スキーマ設計
  - [ ] デフォルトプリセット作成

- [ ] **1.3.3.2** プリセット切替実装
  - [ ] クロスフェード実装（30ms）
  - [ ] パラメータ補間

#### 1.3.4 検証
- [ ] **1.3.4.1** 各DSPモジュール単体テスト
- [ ] **1.3.4.2** Chain 結合テスト
- [ ] **1.3.4.3** レイテンシ測定

### 1.4 Audio Engine（統合）

#### 1.4.1 実装
- [ ] **1.4.1.1** AudioEngine クラス
  - [ ] 状態管理（IDLE/ARMED/RUNNING/DEGRADED/ERROR）
  - [ ] Capture → DSP → Output パイプライン
  - [ ] スレッド管理

- [ ] **1.4.1.2** Virtual Mic 出力
  - [ ] 共有メモリ経由の音声供給
  - [ ] フェードイン/アウト

- [ ] **1.4.1.3** Monitor 出力
  - [ ] Physical HP への出力
  - [ ] Monitor 専用ボリューム

- [ ] **1.4.1.4** エラーリカバリ
  - [ ] デバイス切断検出
  - [ ] 自動復旧ロジック
  - [ ] DEGRADED モード移行

#### 1.4.2 検証
- [ ] **1.4.2.1** E2E テスト（Mic → V-Mic）
- [ ] **1.4.2.2** 状態遷移テスト
- [ ] **1.4.2.3** エラーリカバリテスト

### 1.5 UI 実装

#### 1.5.1 メイン画面
- [ ] **1.5.1.1** MainView レイアウト
  - [ ] Speaking ON/OFF トグル
  - [ ] 状態インジケータ

- [ ] **1.5.1.2** ControlPanel
  - [ ] 入力デバイス選択
  - [ ] プリセット選択
  - [ ] レイテンシモード選択
  - [ ] Monitor ON/OFF

- [ ] **1.5.1.3** VUMeter
  - [ ] 入力レベル表示
  - [ ] 出力レベル表示
  - [ ] ピーク表示

- [ ] **1.5.1.4** StatusIndicator
  - [ ] 状態テキスト表示
  - [ ] エラー詳細表示
  - [ ] 復旧ガイド表示

#### 1.5.2 設定画面
- [ ] **1.5.2.1** SettingsView
  - [ ] オーディオ設定
  - [ ] 詳細設定（バッファサイズ等）
  - [ ] ログエクスポート

#### 1.5.3 その他
- [ ] **1.5.3.1** メニューバーアイコン（任意）
- [ ] **1.5.3.2** 初回セットアップウィザード

### 1.6 設定・永続化

- [ ] **1.6.1** SettingsStore 実装
  - [ ] UserDefaults ラッパー
  - [ ] 設定項目定義
  - [ ] マイグレーション対応

- [ ] **1.6.2** プリセットファイル管理
  - [ ] ファイル保存/読み込み
  - [ ] エクスポート/インポート

### 1.7 インストーラ・配布

- [ ] **1.7.1** pkg インストーラ作成
  - [ ] ドライバインストールスクリプト
  - [ ] アンインストールスクリプト
  - [ ] 署名設定

- [ ] **1.7.2** Notarization
  - [ ] Apple Notarization 対応
  - [ ] Stapling

- [ ] **1.7.3** GCP 配布
  - [ ] Cloud Storage へのアップロード自動化
  - [ ] ダウンロードURL生成

### 1.8 Phase 1 検証

- [ ] **1.8.1** 機能テスト（FT-01〜FT-05）
- [ ] **1.8.2** 互換性テスト（CT-01: Google Meet Chrome）
- [ ] **1.8.3** 性能テスト（PT-01〜PT-04）
- [ ] **1.8.4** 安定性テスト（ST-01: 30分連続）
- [ ] **1.8.5** 異常系テスト（ET-01〜ET-03）

---

## Phase 2: Listening Mode + 安定化

### 2.1 仮想スピーカードライバ (Virtual Spk)

- [ ] **2.1.1** VirtualSpkDriver 設計
- [ ] **2.1.2** VirtualSpkDriver 実装
- [ ] **2.1.3** 検証（出力デバイスとして認識）

### 2.2 Listening Mode 実装

- [ ] **2.2.1** V-Spk からのキャプチャ実装
- [ ] **2.2.2** Physical HP への出力実装
- [ ] **2.2.3** Listening 専用 DSP Chain
- [ ] **2.2.4** UI 拡張（Listening ON/OFF）

### 2.3 AEC（エコーキャンセル）

- [ ] **2.3.1** AEC アルゴリズム選定・調査
- [ ] **2.3.2** AEC 実装
- [ ] **2.3.3** Speaking + Listening 同時使用テスト
- [ ] **2.3.4** 安全モード実装（AEC無効時の制限）

### 2.4 安定化・互換性向上

- [ ] **2.4.1** Zoom 互換性対応
- [ ] **2.4.2** Teams 互換性対応
- [ ] **2.4.3** Safari 対応
- [ ] **2.4.4** Bluetooth 遅延検出・警告
- [ ] **2.4.5** 2時間連続安定性確保

### 2.5 GCP 連携強化

- [ ] **2.5.1** クラッシュレポート送信（Cloud Storage）
- [ ] **2.5.2** 診断データ収集（オプトイン）
- [ ] **2.5.3** アップデート通知機能

### 2.6 Phase 2 検証

- [ ] **2.6.1** 互換性テスト（CT-02〜CT-05）
- [ ] **2.6.2** 安定性テスト（ST-02: 2時間連続）
- [ ] **2.6.3** AEC テスト
- [ ] **2.6.4** Bluetooth テスト

---

## Phase 3: 高度な音声変換

### 3.1 軽量ニューラルVC

- [ ] **3.1.1** RVC / So-VITS 調査
- [ ] **3.1.2** Core ML モデル変換
- [ ] **3.1.3** リアルタイム推論実装
- [ ] **3.1.4** GPU (Metal) アクセラレーション

### 3.2 カスタム音声登録

- [ ] **3.2.1** 音声録音UI
- [ ] **3.2.2** 前処理パイプライン（VAD, 正規化）
- [ ] **3.2.3** モデルファインチューニング（GCP上）
- [ ] **3.2.4** モデルダウンロード・適用

### 3.3 GCP バックエンド

- [ ] **3.3.1** Cloud Functions: 音声処理API
- [ ] **3.3.2** Cloud Run: モデルトレーニングジョブ
- [ ] **3.3.3** Firestore: ユーザープリセット同期
- [ ] **3.3.4** Cloud Storage: モデルファイル配信

### 3.4 Phase 3 検証

- [ ] **3.4.1** ニューラルVC 品質評価
- [ ] **3.4.2** レイテンシテスト（ニューラルVC込み）
- [ ] **3.4.3** GPU 使用率テスト

---

## 継続的タスク

### CI/CD

- [ ] **CI-01** Cloud Build パイプライン構築
- [ ] **CI-02** 自動テスト実行
- [ ] **CI-03** 自動署名・Notarization
- [ ] **CI-04** リリースビルド自動化

### ドキュメント

- [ ] **DOC-01** README.md 作成
- [ ] **DOC-02** ユーザーガイド作成
- [ ] **DOC-03** トラブルシューティングガイド
- [ ] **DOC-04** API ドキュメント（内部）

### 運用

- [ ] **OPS-01** モニタリングダッシュボード（GCP）
- [ ] **OPS-02** アラート設定
- [ ] **OPS-03** バックアップ設定

---

## 優先度・依存関係マップ

```
Phase 0 (環境構築)
    │
    ├─→ 0.1 開発環境 ─→ 0.3 プロジェクト構造
    │
    └─→ 0.2 GCP環境 ─────────────────────────────────┐
                                                      │
Phase 1 (MVP)                                         │
    │                                                 │
    ├─→ 1.1 Virtual Mic ─┬─→ 1.4 Audio Engine ──→ 1.7 インストーラ
    │                    │         │                  │
    ├─→ 1.2 Audio Capture┤         │                  │
    │                    │         │                  │
    └─→ 1.3 DSP Chain ───┘         │                  │
                                   │                  │
                          1.5 UI ──┤                  │
                                   │                  │
                          1.6 設定 ┘                  │
                                                      │
                                   1.8 Phase1検証 ←───┘
                                         │
                                         ▼
Phase 2 (Listening)                      │
    │                                    │
    ├─→ 2.1 Virtual Spk ─→ 2.2 Listening Mode
    │                              │
    └─→ 2.3 AEC ───────────────────┤
                                   │
                          2.4 安定化
                                   │
                          2.5 GCP連携強化
                                   │
                          2.6 Phase2検証
                                   │
                                   ▼
Phase 3 (ニューラルVC)             │
    │                              │
    ├─→ 3.1 軽量ニューラルVC       │
    │                              │
    ├─→ 3.2 カスタム音声登録       │
    │                              │
    └─→ 3.3 GCPバックエンド ←──────┘
                │
                ▼
        3.4 Phase3検証
```

---

## 次に着手すべきタスク

### 即座に開始可能
1. **0.1.1** Xcode インストール確認
2. **0.2.1** GCP プロジェクト作成
3. **1.1.1.1** BlackHole ソースコード調査

### ブロッカー確認が必要
- Apple Developer Program 登録状況
- GCP 請求先アカウント設定

---

## 更新履歴

| 日付 | 更新内容 | 担当 |
|------|---------|------|
| 2025-12-27 | 初版作成 | Claude |
